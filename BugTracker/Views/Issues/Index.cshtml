@model IEnumerable<BugTracker.Models.Issue>

@{
    ViewData["Title"] = "Issues";
}

<link rel="stylesheet" href="~/css/IssuesIndex.css" />
<link rel="stylesheet" href="~/lib/toastify-js/toastify.min.css" />

<h1>Issues</h1>

<a asp-action="Edit" class="btn-primary btn p-2">New Issue</a>

<!-- Button trigger modal -->
<button type="button" class="btn btn-primary" id="modal-btn" data-toggle="modal" data-target="#exampleModal">
    Launch demo modal
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                ...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">

    <div class="">
        <input id="hide-closed" name="hide-closed" type="checkbox" class="form-checkbox " />
        <label for="hide-closed">Hide closed</label>
        <input id="hide-resolved" name="hide-resolved" type="checkbox" value="" class='form-checkbox' />
        <label for="hide-resolved">Hide resolved</label>
    </div>

    <table id="issuesTable" class="table table-sm  table-responsive  table-hover align-middle ">
        <thead class="">
            <tr class="">
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.Id)
                </th>
                <th style="width: 15.88%">
                    @Html.DisplayNameFor(i => i.Title)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.Status)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.Priority)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.Project)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.CreatedDate)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.UpdatedDate)
                </th>
                <th style="width: 8.88%">
                    @Html.DisplayNameFor(i => i.ResolvedDate)
                </th>
                <th class="text-center" data-class-name="Actions" style="width: 8.88%">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

</div>

<div id="prioritiesModal" class="d-flex justify-items-center px-5 align-items-center d-none">
    <section id="first" class="section">
        <div class="radio-container"> <input type="radio" name="group1" id="radio-1" value="1"> <label for="radio-1"><span class="radio">Critical</span></label> </div>
        <div class="radio-container"> <input type="radio" name="group1" id="radio-2" value="2"> <label for="radio-2"><span class="radio">High</span></label> </div>
        <div class="radio-container"> <input type="radio" name="group1" id="radio-3" value="3"> <label for="radio-3"><span class="radio">Medium High</span></label> </div>
        <div class="radio-container"> <input type="radio" name="group1" id="radio-4" value="4"> <label for="radio-4"><span class="radio">Medium Low</span></label> </div>
        <div class="radio-container"> <input type="radio" name="group1" id="radio-5" value="5"> <label for="radio-5"><span class="radio">Low</span></label> </div>
    </section>
</div>


@section scripts{
<script src="~/lib/toastify-js/toastify.min.js"> </script>
<script>

    $(document).ready(function(){

        Toastify({
            text:"Welcome!",
            duration:3000,
            style: {
                background: "linear-gradient(to right, #00B09B, #96C96D)"
            }

        }).showToast();

        //console.log($.ajax({url: '/api/issues'}));

        $("#issuesTable").DataTable({
            ajax: {
                url: "/api/issues",
                dataSrc: ""     // object that contains the data, empty if not nested
            },
            columns:[
                {
                    data:"id",
                    render: function(data, type, issue) {
                        return "<a href='/issues/details/" + issue.id + "' >BT-" + data + "</a>";
                    }
                },
                {
                    data:"title",
                    render: function(data, type, issue) {
                        return "<a href='/issues/details/" + issue.id + "' >BT-" + data + "</a>";
                    }
                },
                {
                    data:"status.name",
                },
                {
                    data:"priority.name",
                },
                {
                    data:"project.name",
                },
                {
                    data:"createdDate"

                },
                {
                    data:"updatedDate",
                },
                {
                    data:"resolvedDate",
                },
                {
                    data:"id",
                    render: function(data, type, issue) {
                        return (
                            `<div class="d-flex justify-content-between gap-2">
                                    <a href="issues/edit/`+issue.id+`" class=" btn w-50 btn-sm btn-secondary">Edit</a>
                                    <button data-issue-id="`+issue.id+`" class="btn btn-danger js-close">Close</button>
                                </div>
                            <div class="d-flex justify-content-center mt-2  ">
                                <button type="button" class="btn btn-danger btn-rounded mb-4 ">
                                    Prioritize
                                </button>
                            </div>`
                        )
                    }
                }
            ]
        });


    // FILTERS

        //RESOLVE
        $("#hide-resolved").on("click", () =>{
            $("tbody tr").filter(function () {

            })
        })





    // MODALS
        $("#modal-btn").on("click", () => {
            $("#exampleModal").modal("show")
        })

        $('#myModal').on('shown.bs.modal', function () {
            console.log("ASD")
            $('#myInput').trigger('focus')
        })



    // CLOSE ISSUE
        $("#issuesTable").on("click", ".js-close", function() {

            let status = $(this).parent().parent().siblings().first().next().next();
            console.log(status)
            if (status.text() == "Closed"){
                Toastify({
                    text: "This issue is already closed!",
                    duration:3000,
                    offset:{
                        x: 150,
                        y: 150
                    },
                    style: {
                        background: "linear-gradient(to right, #EE4242, #990201)",
                        fontSize: "20px",
                        position: "center",
                    }
                }).showToast();
            }

            else if (confirm("Are you sure you want to close this issue?")){

                status.text("Closed");
                $.ajax({
                    url :"api/issues/" +$(this).attr("data-issue-id"),
                    method: "DELETE",
                    success: () => {
                        console.log("succes");
                    },
                    error: () => {

                    }
                })
            }
        });



    });
</script>
}
